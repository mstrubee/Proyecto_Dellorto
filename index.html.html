<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rectificaci√≥n</title>
  <!-- Librer√≠as para exportar a PDF y Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
    }
    h2 {
      margin-bottom: 5px;
    }
    /* √Årea para los datos del proyecto */
    .project-info {
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    input.project-input {
      font-size: 1em;
      width: 300px;
      padding: 4px;
      margin-bottom: 5px;
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px; /* Filas m√°s compactas */
      text-align: left;
      white-space: nowrap;
      font-size: 0.9em;
    }
    th {
      background-color: #f4f4f4;
    }
    input, button, select {
      margin: 2px;
      padding: 4px;
      font-size: 0.9em;
    }
    .btn-eliminar {
      background-color: red;
      color: white;
      border: none;
      padding: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    /* Estilos para el modal de exportaci√≥n */
    #modalGuardar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #modalGuardar .modal-content {
      background: #fff;
      padding: 20px;
      width: 300px;
      margin: 100px auto;
      text-align: center;
    }
    #modalGuardar .modal-content button {
      margin: 5px;
      padding: 6px;
    }
  </style>
</head>
<body>
  <h2>Rectificaci√≥n</h2>
  <!-- √Årea para ingresar datos del proyecto -->
  <div class="project-info">
    <input type="text" id="nombreProyecto" class="project-input" 
           value="nombre del proyecto" 
           onfocus="if(this.value=='nombre del proyecto') this.value='';" 
           onblur="if(this.value=='') this.value='nombre del proyecto';">
    <input type="text" id="codigoProyecto" class="project-input" 
           value="codigo del proyecto" 
           onfocus="if(this.value=='codigo del proyecto') this.value='';" 
           onblur="if(this.value=='') this.value='codigo del proyecto';">
  </div>

  <table>
    <tr>
      <th>Eliminar</th>
      <th>Elemento</th>
      <th>Tipo</th>
      <th>Nombre</th>
      <th>Cantidad</th>
      <th>Ancho (mm)</th>
      <th>Alto (mm)</th>
      <th>Asentamiento (mm)</th>
      <th>m¬≤</th>
      <th>mL</th>
    </tr>
    <tbody id="tablaRectificacion"></tbody>
  </table>

  <button onclick="agregarFila()">Agregar Fila</button>
  <button onclick="mostrarOpcionesGuardar()">Guardar Rectificaci√≥n</button>

  <!-- Modal para exportaci√≥n -->
  <div id="modalGuardar">
    <div class="modal-content">
      <h3>Guardar como:</h3>
      <button onclick="exportarPDF()">PDF</button>
      <button onclick="exportarExcel()">Excel</button>
      <button onclick="exportarHTML()">HTML</button>
      <button onclick="cerrarModalGuardar()">Cancelar</button>
    </div>
  </div>

  <script>
    // Se cargan los datos de localStorage o se inicializan arrays vac√≠os.
    let productos = JSON.parse(localStorage.getItem("productos")) || [];
    let rectificaciones = JSON.parse(localStorage.getItem("rectificaciones")) || [];

    // Opciones para el desplegable "Tipo"
    const opcionesTipo = [
      "Corredera",
      "Guillotina",
      "Proyectante",
      "Oscilobatiente",
      "Ventana Fija",
      "Baranda",
      "Puerta/Ventana",
      "Abatir Interior",
      "Abatir Exterior",
      "Ventana Pleagable",
      "Cortina Cristal",
      "Baranda Banquina",
      "Baranda Botones (perforado)",
      "Lucarnas",
      "Shower",
      "Espejo",
      "Mampara",
      "Puerta Protex"
    ];

    function inicializarRectificacion() {
      // Se obtienen las categor√≠as existentes en productos y se a√±ade "Ventana" si no est√° presente.
      let categorias = [...new Set(productos.map(p => p.categoria))];
      if (!categorias.includes("Ventana")) {
        categorias.push("Ventana");
      }
      // Se ordenan alfab√©ticamente
      categorias.sort((a, b) => a.localeCompare(b));
      actualizarTablaRectificacion(categorias);
    }

    function actualizarTablaRectificacion(categorias) {
      let tabla = document.getElementById("tablaRectificacion");
      tabla.innerHTML = "";
      
      rectificaciones.forEach((rectificacion, index) => {
        let fila = document.createElement("tr");

        // Bot√≥n de eliminaci√≥n
        let celdaEliminar = document.createElement("td");
        let botonEliminar = document.createElement("button");
        botonEliminar.textContent = "üóëÔ∏è";
        botonEliminar.className = "btn-eliminar";
        botonEliminar.onclick = () => eliminarFila(index);
        celdaEliminar.appendChild(botonEliminar);
        fila.appendChild(celdaEliminar);

        // Columna "Elemento": desplegable con opci√≥n por defecto "Seleccione" en rojo.
        let celdaElemento = document.createElement("td");
        let selectElemento = document.createElement("select");
        let defaultOptionElem = document.createElement("option");
        defaultOptionElem.value = "";
        defaultOptionElem.textContent = "Seleccione";
        defaultOptionElem.style.color = "red";
        defaultOptionElem.disabled = true;
        if (!rectificaciones[index].elemento) {
          defaultOptionElem.selected = true;
        }
        selectElemento.appendChild(defaultOptionElem);
        categorias.forEach(categoria => {
          let opcion = document.createElement("option");
          opcion.value = categoria;
          opcion.textContent = categoria;
          if (categoria === rectificaciones[index].elemento) {
            opcion.selected = true;
          }
          selectElemento.appendChild(opcion);
        });
        selectElemento.onchange = () => {
          rectificaciones[index].elemento = selectElemento.value;
          guardarRectificacion();
        };
        celdaElemento.appendChild(selectElemento);
        fila.appendChild(celdaElemento);

        // Columna "Tipo": desplegable con opci√≥n por defecto "Seleccione" en rojo y opciones ordenadas alfab√©ticamente.
        let celdaTipo = document.createElement("td");
        let selectTipo = document.createElement("select");
        let defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Seleccione";
        defaultOption.style.color = "red";
        defaultOption.disabled = true;
        if (!rectificaciones[index].tipo) {
          defaultOption.selected = true;
        }
        selectTipo.appendChild(defaultOption);
        let sortedTipos = opcionesTipo.slice().sort((a, b) => a.localeCompare(b));
        sortedTipos.forEach(tipoOption => {
          let opt = document.createElement("option");
          opt.value = tipoOption;
          opt.textContent = tipoOption;
          if (tipoOption === rectificaciones[index].tipo) {
            opt.selected = true;
          }
          selectTipo.appendChild(opt);
        });
        selectTipo.onchange = () => {
          rectificaciones[index].tipo = selectTipo.value;
          guardarRectificacion();
        };
        celdaTipo.appendChild(selectTipo);
        fila.appendChild(celdaTipo);

        // Columna "Nombre"
        fila.appendChild(crearCeldaInput("text", rectificacion.nombre, index, "nombre"));
        // Columna "Cantidad"
        fila.appendChild(crearCeldaInput("number", rectificacion.cantidad, index, "cantidad"));
        // Columna "Ancho (mm)"
        fila.appendChild(crearCeldaInput("number", rectificacion.ancho, index, "ancho"));
        // Columna "Alto (mm)"
        fila.appendChild(crearCeldaInput("number", rectificacion.alto, index, "alto"));
        // Columna "Asentamiento (mm)"
        fila.appendChild(crearCeldaInput("number", rectificacion.asentamiento, index, "asentamiento"));

        // Columna "m¬≤": (ancho * (alto + asentamiento)) / 1,000,000
        let celdaM2 = document.createElement("td");
        celdaM2.id = `m2-${index}`;
        celdaM2.textContent = calcularM2(rectificacion.ancho, rectificacion.alto, rectificacion.asentamiento) + " m¬≤";
        fila.appendChild(celdaM2);

        // Columna "mL": ((ancho * 2) + ((alto + asentamiento) * 2)) / 1,000
        let celdaML = document.createElement("td");
        celdaML.id = `ml-${index}`;
        celdaML.textContent = calcularML(rectificacion.ancho, rectificacion.alto, rectificacion.asentamiento) + " m";
        fila.appendChild(celdaML);

        tabla.appendChild(fila);
      });
    }

    // Funci√≥n gen√©rica para crear una celda con input.
    function crearCeldaInput(tipo, valor, indice, propiedad) {
      let celda = document.createElement("td");
      let input = document.createElement("input");
      input.type = tipo;
      input.value = (valor !== undefined && valor !== null) ? valor : "";
      
      // Para "ancho", "alto" y "asentamiento": si el valor es "0", se borra al hacer foco.
      if (["ancho", "alto", "asentamiento"].includes(propiedad)) {
        input.addEventListener("focus", function() {
          if (input.value === "0") { input.value = ""; }
        });
      }
      
      input.oninput = function(event) {
        if (["cantidad", "ancho", "alto", "asentamiento"].includes(propiedad)) {
          rectificaciones[indice][propiedad] = parseFloat(event.target.value) || 0;
          actualizarCalculosSinRedibujar(indice);
        } else {
          rectificaciones[indice][propiedad] = event.target.value;
        }
      };
      celda.appendChild(input);
      return celda;
    }

    // Funci√≥n para calcular m¬≤: (ancho * (alto + asentamiento)) / 1,000,000
    function calcularM2(ancho, alto, asentamiento) {
      let a = parseFloat(ancho) || 0;
      let h = parseFloat(alto) || 0;
      let asen = parseFloat(asentamiento) || 0;
      return ((a * (h + asen)) / 1000000).toFixed(2);
    }

    // Funci√≥n para calcular mL: ((ancho * 2) + ((alto + asentamiento) * 2)) / 1,000
    function calcularML(ancho, alto, asentamiento) {
      let a = parseFloat(ancho) || 0;
      let h = parseFloat(alto) || 0;
      let asen = parseFloat(asentamiento) || 0;
      return (((a * 2) + ((h + asen) * 2)) / 1000).toFixed(2);
    }

    // Actualiza los c√°lculos sin redibujar toda la tabla.
    function actualizarCalculosSinRedibujar(index) {
      let rectificacion = rectificaciones[index];
      rectificacion.m2 = calcularM2(rectificacion.ancho, rectificacion.alto, rectificacion.asentamiento);
      rectificacion.ml = calcularML(rectificacion.ancho, rectificacion.alto, rectificacion.asentamiento);
      let celdaM2 = document.getElementById(`m2-${index}`);
      let celdaML = document.getElementById(`ml-${index}`);
      if (celdaM2) celdaM2.textContent = rectificacion.m2 + " m¬≤";
      if (celdaML) celdaML.textContent = rectificacion.ml + " m";
      guardarRectificacion();
    }

    // Agrega una nueva fila con valores predeterminados.
    function agregarFila() {
      rectificaciones.push({
        elemento: "",
        tipo: "",
        nombre: "",
        cantidad: 1,
        ancho: 0,
        alto: 0,
        asentamiento: 0,
        m2: "0.00",
        ml: "0.00"
      });
      guardarRectificacion();
      inicializarRectificacion();
    }

    // Elimina la fila indicada.
    function eliminarFila(index) {
      rectificaciones.splice(index, 1);
      guardarRectificacion();
      inicializarRectificacion();
    }

    // Guarda el array "rectificaciones" en localStorage.
    function guardarRectificacion() {
      localStorage.setItem("rectificaciones", JSON.stringify(rectificaciones));
    }

    // Funciones para mostrar y ocultar el modal de exportaci√≥n.
    function mostrarOpcionesGuardar() {
      document.getElementById("modalGuardar").style.display = "block";
    }
    function cerrarModalGuardar() {
      document.getElementById("modalGuardar").style.display = "none";
    }

    // Exporta a PDF usando jsPDF y autoTable.
    function exportarPDF() {
      cerrarModalGuardar();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'pt', 'a4');
      doc.text("Rectificaciones", 40, 40);
      const columns = ["Elemento", "Tipo", "Nombre", "Cantidad", "Ancho", "Alto", "Asentamiento", "m¬≤", "mL"];
      const rows = rectificaciones.map(item => [
        item.elemento || "Seleccione",
        item.tipo || "Seleccione",
        item.nombre,
        item.cantidad,
        item.ancho,
        item.alto,
        item.asentamiento,
        item.m2,
        item.ml
      ]);
      doc.autoTable({
        head: [columns],
        body: rows,
        startY: 60
      });
      doc.save("rectificaciones.pdf");
    }

    // Exporta a Excel usando SheetJS.
    function exportarExcel() {
      cerrarModalGuardar();
      const wb = XLSX.utils.book_new();
      const ws_data = [["Elemento", "Tipo", "Nombre", "Cantidad", "Ancho", "Alto", "Asentamiento", "m¬≤", "mL"]];
      rectificaciones.forEach(item => {
        ws_data.push([
          item.elemento || "Seleccione",
          item.tipo || "Seleccione",
          item.nombre,
          item.cantidad,
          item.ancho,
          item.alto,
          item.asentamiento,
          item.m2,
          item.ml
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "Rectificaciones");
      XLSX.writeFile(wb, "rectificaciones.xlsx");
    }

    // Exporta el c√≥digo HTML completo actual a un archivo, sincronizando los valores de los inputs.
    function exportarHTML() {
      cerrarModalGuardar();
      // Sincronizaci√≥n: Actualiza el atributo "value" de cada <input> con su valor actual.
      document.querySelectorAll("input").forEach(input => {
        input.setAttribute("value", input.value);
      });
      let htmlCode = document.documentElement.outerHTML;
      let blob = new Blob([htmlCode], { type: "text/html" });
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "rectificacion.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Inicializa la tabla al cargar la p√°gina.
    inicializarRectificacion();
  </script>
</body>
</html>
